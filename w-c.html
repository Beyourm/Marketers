<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ÙˆÙ‘Ù‚</title>
<link rel="stylesheet" href="../assets/fonts/tajawal.css">
<style>
/* ===============================
   CSS Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø© 
   =============================== */
:root {
  --primary-color: #0d3b14; /* ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ© */
  --secondary-color: #e5a72d; /* Ù„ÙˆÙ† Ø«Ø§Ù†ÙˆÙŠ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£ØµÙ„ÙŠØ© */
  --accent-color: #f7f3e9; 
  --text-color-dark: #2d3748;
  --danger-color: #dc3545;
  --white-color: #ffffff; 
  --success-color: #28a745;
  --status-pending-bg: #fff8e8; /* Ø£ØµÙØ±/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
}
body {
  font-family: "Tajawal", sans-serif;
  background: linear-gradient(120deg, var(--accent-color) 0%, #eaf0f5 100%); 
  margin: 0; padding: 20px;
  min-height: 100vh;
  display: flex; justify-content: center; align-items: flex-start;
  color: var(--text-color-dark);
}

.card-wrapper {
  width: 100%;
  max-width: 600px; 
  margin-top: 50px;
}

.card {
  background: linear-gradient(145deg, #ffffff, var(--accent-color));
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  text-align: center;
  position: relative;
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(0,0,0,0.2);
}

.card-title {
  font-size: 1.8rem;
  color: var(--primary-color);
  margin-bottom: 25px;
  border-bottom: 3px solid var(--secondary-color);
  padding-bottom: 10px;
}

.balance-display {
  font-size: 2.5rem;
  font-weight: bold;
  color: var(--success-color);
  margin-bottom: 25px;
  background-color: #e6ffed;
  padding: 15px;
  border-radius: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.balance-display span {
    margin-right: 10px;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ø­Ø¨ */
.withdrawal-form {
    text-align: right;
    margin-top: 30px;
}
.withdrawal-form label {
    display: block;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-color-dark);
    font-size: 15px;
}
.withdrawal-form input[type="number"],
.withdrawal-form input[type="text"],
.withdrawal-form select {
    width: 100%;
    padding: 12px;
    margin-bottom: 20px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 16px;
    font-family: "Tajawal", sans-serif;
    direction: rtl;
    text-align: right;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ±ÙƒÙŠØ² */
.withdrawal-form input[type="number"]:focus,
.withdrawal-form input[type="text"]:focus,
.withdrawal-form select:focus {
    border-color: var(--secondary-color); 
    box-shadow: 0 0 0 4px rgba(229, 167, 45, 0.2); 
    outline: none; 
}


.withdrawal-form select {
    appearance: none;
    background: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%230d3b14%22%20d%3D%22M287%2069.4L146.2%20208.7L5.4%2069.4H287z%22%2F%3E%3C%2Fsvg%3E') no-repeat right 10px center;
    background-size: 12px;
    padding-left: 35px; 
}

button.submit-btn {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 10px;
    background: var(--primary-color);
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.3s, transform 0.1s;
    font-weight: 700;
}
button.submit-btn:hover { background: #1a5c24; }
button.submit-btn:active { transform: scale(0.99); }
button.submit-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª */
.history-section {
    margin-top: 40px;
    text-align: right;
}
.history-section h3 {
    color: var(--primary-color);
    border-bottom: 2px dashed #eee;
    padding-bottom: 8px;
    margin-bottom: 15px;
}

.withdrawal-record {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.record-details {
    text-align: right;
}
.record-details strong {
    color: var(--text-color-dark);
}
.record-date {
    font-size: 12px;
    color: #555; /* Ù„ÙˆÙ† Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„ÙØ±Ø¹ÙŠØ© */
    margin-top: 4px;
}
.sending-fee {
    font-weight: 500;
    color: var(--danger-color);
}

.status-badge {
    padding: 6px 10px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 12px;
    color: white;
}
.status-badge.paid { background-color: var(--success-color); }
.status-badge.pending { background-color: var(--secondary-color); }
.status-badge.rejected { background-color: var(--danger-color); }


/* Spinner Ùˆ Toast */
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid var(--secondary-color);
  border-radius: 50%;
  width: 20px;
  height: 20px;
  margin-left: 10px;
  animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--primary-color);
  color: white;
  padding: 10px 18px;
  border-radius: 10px;
  opacity: 0;
  transition: opacity 0.5s;
  z-index: 1000;
  display: flex;
  align-items: center;
}
.toast i { margin-left: 8px; }
.toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="card-wrapper">
  <div class="card">
    <h2 class="card-title">Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</h2>
    
    <div class="balance-display">
      <span id="available-balance"><div class="loader"></div></span>
      <span style="font-size: 0.8em; font-weight: normal; color: #555;">(Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…ØªØ§Ø­)</span>
    </div>
    
    <p style="font-size: 14px; color: var(--danger-color); font-weight: 600;">âš ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨: 50.00 $</p>
    
    <p style="font-size: 13px; color: var(--primary-color); font-weight: 500; margin-top: 10px; border: 1px dashed #ddd; padding: 10px; border-radius: 5px; text-align: right;">
ğŸ”¹ ØªÙ†ÙˆÙŠÙ‡ Ù‡Ø§Ù…:
ØªÙØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù„Ø¯ÙŠÙ†Ø§ Ø¨Ø¯Ù‚Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø©ØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.
ÙˆØ³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ø³ØªÙ†Ø§Ø¯Ø§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø©ØŒ Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø­Ø±ØµØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø© ÙˆØ³Ù„Ø§Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.
    </p>


    <div class="withdrawal-form">
      <label for="withdrawal-amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡ ($):</label>
      <input type="number" id="withdrawal-amount" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 50" min="50" step="1" required>
      <p id="amount-error" style="color: var(--danger-color); font-size: 13px; margin-top: -10px; margin-bottom: 20px; text-align: right; display: none;">&nbsp;</p>

      <label for="payment-method">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (Ø§Ù„Ù…Ø­ÙØ¸Ø©/Ø§Ù„Ø­Ø³Ø§Ø¨):</label>
      <select id="payment-method" required>
        <option value="">-- Ø§Ø®ØªØ± Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ --</option>
        <option value="Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ">Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ</option>
        <option value="Ù…Ø­ÙØ¸Ø© ÙƒØ§Ø´">Ù…Ø­ÙØ¸Ø© ÙƒØ§Ø´</option>
        <option value="Ø¨Ù†Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ">Ø¨Ù†Ùƒ Ø§Ù„ÙƒØ±ÙŠÙ…ÙŠ</option>
        <option value="Ø§Ù„Ù†Ø¬Ù… Ù„Ù„ØµØ±Ø§ÙØ©">Ø§Ù„Ù†Ø¬Ù… Ù„Ù„ØµØ±Ø§ÙØ©</option>
        <option value="Ù…Ø­ÙØ¸Ø© ÙÙ„ÙˆØ³Ùƒ">Ù…Ø­ÙØ¸Ø© ÙÙ„ÙˆØ³Ùƒ</option>
        <option value="PayPal">PayPal</option>
        <option value="Other">Ø£Ø®Ø±Ù‰ </option>
      </select>
      
      <label for="payment-details" id="details-label">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ (Ø§Ù„Ø±Ù‚Ù…/Ø§Ù„Ø­Ø³Ø§Ø¨):</label>
      <input type="text" id="payment-details" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ø­ÙØ¸Ø©" required>
      
      <label for="contact-method">ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ (ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„ØªØ£ÙƒÙŠØ¯):</label>
      <input type="text" id="contact-method" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" required>
      
      <button class="submit-btn" id="submit-withdrawal" disabled>
        <i class="fas fa-paper-plane" style="margin-left: 8px;"></i> Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨
      </button>
    </div>

    <div class="history-section">
      <h3>Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
      <div id="withdrawal-history">
        <p style="text-align: center; color: #777;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>
      </div>
      <p style="font-size: 12px; color: #888; margin-top: 15px;">Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø®Ù„Ø§Ù„ 3 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„.</p>
    </div>

  </div>

  <div id="toast" class="toast"></div>
</div>

<script>
// ----------------------------------------------------------------------
// Ù…Ù†Ø·Ù‚ JavaScript Ù„ØµÙØ­Ø© Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª (Ù…ÙØ­Ø¯Ù‘ÙØ«)
// ----------------------------------------------------------------------
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxU0xxafym-vOF00ctiSlyJl7qzF9j_m_URuVThEqUEHYi8vl9zO3ykwUntSjY-Fvf3/exec'; // ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·
let marketerId = localStorage.getItem('stored_marketer_id'); 

const balanceEl = document.getElementById('available-balance');
const amountInput = document.getElementById('withdrawal-amount');
const amountErrorEl = document.getElementById('amount-error'); 
const methodSelect = document.getElementById('payment-method');
const detailsInput = document.getElementById('payment-details');
const detailsLabel = document.getElementById('details-label');
// ğŸŒŸ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„
const contactInput = document.getElementById('contact-method');
const submitBtn = document.getElementById('submit-withdrawal');
const historyContainer = document.getElementById('withdrawal-history');

let availableBalance = 0; 

function showToast(msg, isError=false) {
  const toast = document.getElementById('toast');
  toast.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i> ${msg}`;
  toast.style.background = isError ? 'var(--danger-color)' : 'var(--primary-color)';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù…ÙØ­Ø¯Ù‘ÙØ« Ù„ÙŠØ´Ù…Ù„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„)
function checkFormValidity() {
    const amount = Number(amountInput.value);
    const method = methodSelect.value;
    const details = detailsInput.value;
    const contact = contactInput.value; // Ø¬Ù„Ø¨ Ù‚ÙŠÙ…Ø© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„
    
    amountErrorEl.style.display = 'none'; 
    let errorMsg = '';
    let isValidAmount = true;

    if (amountInput.value !== '') {
        if (amount < 50) {
            errorMsg = 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 50 Ø¯ÙˆÙ„Ø§Ø±Ø§Ù‹.';
            isValidAmount = false;
        } else if (amount > availableBalance) {
            errorMsg = `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø£ÙƒØ¨Ø± Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØªØ§Ø­ (${availableBalance.toLocaleString('en-US', {minimumFractionDigits: 2})} $).`;
            isValidAmount = false;
        }
    }
    
    if (errorMsg) {
        amountErrorEl.textContent = errorMsg;
        amountErrorEl.style.display = 'block';
    }

    // ğŸŒŸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„)
    const isValid = marketerId && 
                    isValidAmount && 
                    amountInput.value !== '' && 
                    method !== '' && 
                    details.trim() !== '' && // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø£ØµØ¨Ø­Øª Ù…Ø·Ù„ÙˆØ¨Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
                    contact.trim() !== ''; // ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©
    
    submitBtn.disabled = !isValid;
}
amountInput.addEventListener('input', checkFormValidity);
methodSelect.addEventListener('change', checkFormValidity);
detailsInput.addEventListener('input', checkFormValidity);
contactInput.addEventListener('input', checkFormValidity); // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„


// 2. Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
async function fetchWithdrawalData() {
    if (!marketerId) {
        balanceEl.textContent = 'Ø§Ù„Ù…Ø¹Ø±Ù Ù…ÙÙ‚ÙˆØ¯';
        historyContainer.innerHTML = '<p style="text-align: center; color: var(--danger-color);">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.</p>';
        return;
    }
    
    balanceEl.innerHTML = '<div class="loader"></div>';
    historyContainer.innerHTML = '<p style="text-align: center; color: #777;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>';

    try {
        const res = await fetch(`${APPS_SCRIPT_URL}?action=get_data&marketer_id=${encodeURIComponent(marketerId)}`);
        const data = await res.json();
        
        if (data.success && data.balance !== undefined) {
            availableBalance = Number(data.balance);
            balanceEl.textContent = availableBalance.toLocaleString('en-US', {minimumFractionDigits: 2}) + ' $';
            amountInput.setAttribute('max', availableBalance); 
            renderHistory(data.history || []);
            checkFormValidity();
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        } else {
            throw new Error(data.message || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
        }
        
    } catch(err) {
        balanceEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„!';
        showToast('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø¨ âŒ', true);
        console.error('Fetch error:', err);
    }
}

// 3. Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (Ù…ÙØ­Ø¯Ù‘ÙØ« Ù„ØªØ¶Ù…ÙŠÙ† Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
function renderHistory(history) {
    if (history.length === 0) {
        historyContainer.innerHTML = '<p style="text-align: center; color: #777;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø³Ø­ÙˆØ¨Ø§Øª Ø¨Ø¹Ø¯.</p>';
        return;
    }
    
    historyContainer.innerHTML = '';
    history.sort((a, b) => new Date(b.date) - new Date(a.date)); 

    history.forEach(record => {
        let statusClass = '';
        let statusText = '';
        
        if (record.status === 'Ù…Ø¯ÙÙˆØ¹' || record.status === 'Ù…ÙƒØªÙ…Ù„') {
            statusClass = 'paid';
            statusText = 'ØªÙ… Ø§Ù„Ø¯ÙØ¹';
        } else if (record.status === 'Rejected' || record.status === 'Ù…Ø±ÙÙˆØ¶') {
            statusClass = 'rejected';
            statusText = 'Ù…Ø±ÙÙˆØ¶';
        } else {
            statusClass = 'pending';
            statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
        }

        const detailsText = record.paymentDetails && record.paymentDetails.length > 10 
                            ? record.paymentDetails.substring(0, 10) + '...' 
                            : record.paymentDetails || record.method;

        // ğŸŒŸ Ø¹Ø±Ø¶ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±
        const feeElement = record.sendingFee > 0 
                            ? `<span class="sending-fee"> (+${record.sendingFee.toLocaleString('en-US', {minimumFractionDigits: 2})} $ Ø¹Ù…ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„)</span>` 
                            : '';

        const recordDiv = `
            <div class="withdrawal-record">
                <div class="record-details">
                    <strong>${Number(record.amount).toLocaleString('en-US', {minimumFractionDigits: 2})} $</strong>
                    <div class="record-date">
                        Ø¹Ø¨Ø±: ${detailsText} - Ø¨ØªØ§Ø±ÙŠØ®: ${new Date(record.date).toLocaleDateString('ar-EG')}
                        ${feeElement}
                    </div>
                </div>
                <div class="status-badge ${statusClass}">${statusText}</div>
            </div>
        `;
        historyContainer.innerHTML += recordDiv;
    });
}

// 4. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ (Ù…ÙØ­Ø¯Ù‘ÙØ« Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„)
submitBtn.addEventListener('click', async () => {
    if (submitBtn.disabled) return; 
    
    const amount = amountInput.value;
    const method = methodSelect.value;
    const details = detailsInput.value;
    const contact = contactInput.value; // Ø¬Ù„Ø¨ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„

    if (Number(amount) < 50 || Number(amount) > availableBalance) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰. âŒ', true);
        checkFormValidity();
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="loader" style="width: 15px; height: 15px;"></div> Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
    
    const formData = new FormData();
    formData.append('action', 'request_withdrawal');
    formData.append('marketer_id', marketerId);
    formData.append('amount', amount);
    formData.append('method', method);
    formData.append('details', details); 
    formData.append('contact', contact); // ğŸŒŸ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„

    try {
        const res = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: formData,
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­! âœ…');
            amountInput.value = ''; 
            detailsInput.value = '';
            contactInput.value = ''; // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„
            methodSelect.value = '';
            checkFormValidity();
            fetchWithdrawalData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø³Ø¬Ù„
        } else {
            showToast(data.message || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. âŒ', true);
        }

    } catch(err) {
        showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. âŒ', true);
        console.error('Submission error:', err);
    } finally {
        submitBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-left: 8px;"></i> Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨';
        checkFormValidity(); 
    }
});

// ğŸš€ ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', fetchWithdrawalData);
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</body>
</html>
